name: SLO

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
      - release-*
  workflow_dispatch:
    inputs:
      github_pull_request_number:
        required: true
      baseline_ref:
        description: "Baseline commit/branch/tag to compare against (leave empty to auto-detect merge-base with main)"
        required: false
      slo_workload_duration_seconds:
        default: '600'
        required: false
      slo_workload_read_max_rps:
        default: '1000'
        required: false
      slo_workload_write_max_rps:
        default: '100'
        required: false

jobs:
  ydb-slo-action:
    if: (!contains(github.event.pull_request.labels.*.name, 'no slo'))

    name: Run YDB SLO Tests
    runs-on: 'ubuntu-latest'

    strategy:
      fail-fast: false
      matrix:
        sdk:
          - id: database_sql_table
            name: database-sql-table
            path: ./database/sql/table
            label: database/sql/table
          - id: database_sql_query
            name: database-sql-query
            path: ./database/sql/query
            label: database/sql/query
          - id: native_query
            name: native-query
            path: ./native/query
            label: native/query
          - id: native_table
            name: native-table
            path: ./native/table
            label: native/table
          - id: native_table_over_query_service
            name: native-table-over-query-service
            path: ./native/table/over/query/service
            label: native/table/over/query/service
          - id: native_bulk_upsert
            name: native-bulk-upsert
            path: ./native/bulk-upsert
            label: native/bulk-upsert

    concurrency:
      group: slo-${{ github.ref }}-${{ matrix.sdk.name }}
      cancel-in-progress: true

    steps:
      - name: Checkout current version
        uses: actions/checkout@v5
        with:
          path: current
          fetch-depth: 0

      - name: Determine baseline commit
        id: baseline
        run: |
          cd current
          if [[ -n "${{ inputs.baseline_ref }}" ]]; then
            BASELINE="${{ inputs.baseline_ref }}"
          else
            BASELINE=$(git merge-base HEAD origin/master)
          fi
          echo "sha=$BASELINE" >> $GITHUB_OUTPUT

          # Try to determine a human-readable ref name for baseline
          # Check if baseline is on master
          if git merge-base --is-ancestor $BASELINE origin/master && \
             [ "$(git rev-parse origin/master)" = "$BASELINE" ]; then
            BASELINE_REF="master"
          else
            # Try to find a branch containing this commit
            BRANCH=$(git branch -r --contains $BASELINE | grep -v HEAD | head -1 | sed 's/.*\///' || echo "")
            if [ -n "$BRANCH" ]; then
              BASELINE_REF="${BRANCH}@${BASELINE:0:7}"
            else
              BASELINE_REF="${BASELINE:0:7}"
            fi
          fi
          echo "ref=$BASELINE_REF" >> $GITHUB_OUTPUT

      - name: Checkout baseline version
        uses: actions/checkout@v5
        with:
          ref: ${{ steps.baseline.outputs.sha }}
          path: baseline
          fetch-depth: 1

      - name: Build workload images
        run: |
          # Build current version
          if [ -f "$GITHUB_WORKSPACE/current/tests/slo/Dockerfile" ]; then
            echo "Building current app image..."
            cd "$GITHUB_WORKSPACE/current"
            CURRENT_REF="${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"
            docker build -t ydb-app-current \
              --build-arg SRC_PATH=${{ matrix.sdk.label }} \
              --build-arg JOB_NAME=${{ matrix.sdk.name }} \
              --build-arg REF="${CURRENT_REF}" \
              -f tests/slo/Dockerfile .
          else
            echo "No current app Dockerfile found"
            exit 1
          fi

          # Build baseline version
          if [ -f "$GITHUB_WORKSPACE/baseline/tests/slo/Dockerfile" ]; then
            echo "Building baseline app image..."
            cd "$GITHUB_WORKSPACE/baseline"

            # Copy current versions of build infrastructure to baseline
            echo "Copying current Dockerfile, go.mod, go.sum, and internal to baseline..."
            cp "$GITHUB_WORKSPACE/current/tests/slo/Dockerfile" "$GITHUB_WORKSPACE/baseline/tests/slo/Dockerfile"
            cp "$GITHUB_WORKSPACE/current/tests/slo/go.mod" "$GITHUB_WORKSPACE/baseline/tests/slo/go.mod"
            cp "$GITHUB_WORKSPACE/current/tests/slo/go.sum" "$GITHUB_WORKSPACE/baseline/tests/slo/go.sum"
            rm -rf "$GITHUB_WORKSPACE/baseline/tests/slo/internal"
            cp -r "$GITHUB_WORKSPACE/current/tests/slo/internal" "$GITHUB_WORKSPACE/baseline/tests/slo/internal"

            docker build -t ydb-app-baseline \
              --build-arg SRC_PATH=${{ matrix.sdk.label }} \
              --build-arg JOB_NAME=${{ matrix.sdk.name }} \
              --build-arg REF="${{ steps.baseline.outputs.ref }}" \
              -f tests/slo/Dockerfile .
          else
            echo "No baseline app Dockerfile found"
            exit 1
          fi

      - name: Initialize YDB SLO
        uses: ydb-platform/ydb-slo-action/init@main
        with:
          github_pull_request_number: ${{ github.event.inputs.github_pull_request_number }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workload_name: ${{ matrix.sdk.name }}
          workload_current_ref: ${{ github.head_ref || github.ref_name }}
          workload_baseline_ref: ${{ steps.baseline.outputs.ref }}

      - name: Prepare SLO Database
        run: |
          echo "Preparing SLO database..."
          docker run --rm --network ydb_ydb-net \
            --add-host "ydb:172.28.0.11" \
            --add-host "ydb:172.28.0.12" \
            --add-host "ydb:172.28.0.13" \
            --add-host "ydb:172.28.0.99" \
            ydb-app-current create grpc://ydb:2136 /Root/testdb

      - name: Run SLO Tests (parallel)
        timeout-minutes: 15
        run: |
          DURATION=${{ inputs.slo_workload_duration_seconds || 600 }}
          READ_RPS=${{ inputs.slo_workload_read_max_rps || 1000 }}
          WRITE_RPS=${{ inputs.slo_workload_write_max_rps || 100 }}

          EXTRA_ARGS=""
          if [ "${{ matrix.sdk.id }}" = "native_bulk_upsert" ]; then
            EXTRA_ARGS="--batch-size=10"
          fi

          ARGS="run grpc://ydb:2136 /Root/testdb \
            -otlp-endpoint prometheus:9090 \
            -report-period 250 \
            -time $DURATION \
            -read-rps $READ_RPS \
            -write-rps $WRITE_RPS \
            -read-timeout 500 \
            -write-timeout 100 \
            $EXTRA_ARGS"

          echo "Starting ydb-app-current..."
          docker run -d \
            --name ydb-app-current \
            --network ydb_ydb-net \
            --add-host "ydb:172.28.0.11" \
            --add-host "ydb:172.28.0.12" \
            --add-host "ydb:172.28.0.13" \
            --add-host "ydb:172.28.0.99" \
            ydb-app-current $ARGS

          echo "Starting ydb-app-baseline..."
          docker run -d \
            --name ydb-app-baseline \
            --network ydb_ydb-net \
            --add-host "ydb:172.28.0.11" \
            --add-host "ydb:172.28.0.12" \
            --add-host "ydb:172.28.0.13" \
            ydb-app-baseline $ARGS

          # Show initial logs
          echo ""
          echo "==================== INITIAL CURRENT LOGS ===================="
          docker logs -n 15 ydb-app-current 2>&1 || echo "No current container"
          echo ""
          echo "==================== INITIAL BASELINE LOGS ===================="
          docker logs -n 15 ydb-app-baseline 2>&1 || echo "No baseline container"
          echo ""

          # Wait for workloads to complete
          echo "Waiting for workloads to complete (${DURATION}s)..."
          sleep ${DURATION}

          # Stop containers after workload duration and wait for graceful shutdown
          echo "Stopping containers after ${DURATION}s..."
          docker stop --timeout=30 ydb-app-current ydb-app-baseline 2>&1 || true

          # Force kill if still running
          docker kill ydb-app-current ydb-app-baseline 2>&1 || true

          # Check exit codes
          CURRENT_EXIT=$(docker inspect ydb-app-current --format='{{.State.ExitCode}}' 2>/dev/null || echo "1")
          BASELINE_EXIT=$(docker inspect ydb-app-baseline --format='{{.State.ExitCode}}' 2>/dev/null || echo "0")

          echo "Current container exit code: $CURRENT_EXIT"
          echo "Baseline container exit code: $BASELINE_EXIT"

          # Show final logs
          echo ""
          echo "==================== FINAL CURRENT LOGS ===================="
          docker logs -n 15 ydb-app-current 2>&1 || echo "No current container"
          echo ""
          echo "==================== FINAL BASELINE LOGS ===================="
          docker logs -n 15 ydb-app-baseline 2>&1 || echo "No baseline container"
          echo ""

          echo "SUCCESS: Workloads completed successfully"

      - if: always()
        name: Store logs
        run: |
          docker logs ydb-app-current > current.log 2>&1 || echo "No current container"
          docker logs ydb-app-baseline > baseline.log 2>&1 || echo "No baseline container"

      - if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{matrix.sdk.name}}-logs
          path: |
            ./current.log
            ./baseline.log
          retention-days: 1

      - if: always()
        name: Cleanup SLO Database
        run: |
          echo "Cleaning up SLO database..."

          # Cleanup using current app (if it works)
          docker run --rm --network ydb_ydb-net \
            --add-host "ydb:172.28.0.11" \
            --add-host "ydb:172.28.0.12" \
            --add-host "ydb:172.28.0.13" \
            ydb-app-current cleanup grpc://ydb:2136 /Root/testdb || true

          # Stop and remove app containers
          docker rm -f ydb-app-current ydb-app-baseline 2>/dev/null || true
